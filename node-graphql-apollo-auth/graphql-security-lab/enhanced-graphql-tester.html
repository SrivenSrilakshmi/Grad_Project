<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ°Ô∏è GraphQL Security Testing Dashboard</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --success-color: #059669;
            --warning-color: #d97706;
            --danger-color: #dc2626;
            --dark-bg: #1f2937;
            --card-bg: #f9fafb;
            --border-color: #e5e7eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: var(--dark-bg);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Theme Toggle */
        .theme-toggle {
            background: transparent;
            border: 1px solid currentColor;
            color: currentColor;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: currentColor;
            color: var(--dark-bg);
        }

        /* Export Button */
        .export-btn {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(5, 150, 105, 0.1);
            border: 1px solid var(--success-color);
            color: var(--success-color);
            font-size: 14px;
            font-weight: 500;
        }

        /* Dark Mode Support */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        body.dark-mode .container {
            background: #2d3748;
            color: #e2e8f0;
        }

        body.dark-mode .section {
            background: #4a5568;
            border-color: #718096;
        }

        body.dark-mode .section-header {
            background: #2d3748;
            color: #e2e8f0;
        }

        /* Security Dashboard */
        .security-dashboard {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 20px;
            margin: 20px 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .risk-meter {
            position: relative;
            text-align: center;
        }

        .risk-gauge {
            width: 150px;
            height: 75px;
            border: 4px solid #e5e7eb;
            border-bottom: none;
            border-radius: 150px 150px 0 0;
            position: relative;
            margin-bottom: 10px;
        }

        .risk-needle {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 2px;
            height: 70px;
            background: #dc2626;
            transform-origin: bottom;
            transition: transform 0.5s ease;
        }

        .risk-score {
            font-weight: bold;
            font-size: 16px;
        }

        .threat-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .indicator {
            padding: 10px;
            background: white;
            border-radius: 6px;
            text-align: center;
            border: 1px solid var(--border-color);
            font-size: 14px;
        }

        .indicator.safe { border-color: var(--success-color); color: var(--success-color); }
        .indicator.warning { border-color: var(--warning-color); color: var(--warning-color); }
        .indicator.danger { border-color: var(--danger-color); color: var(--danger-color); }

        /* Attack Sequences */
        .attack-sequences {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 30px;
            margin-bottom: 20px;
        }

        .sequence-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            background: linear-gradient(135deg, var(--primary-color), #3b82f6);
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sequence-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3);
        }

        .sequence-btn.running {
            background: var(--warning-color);
            cursor: not-allowed;
        }

        /* Query Builder */
        .query-builder {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .builder-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .slider-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .slider-group label {
            font-weight: 500;
            font-size: 14px;
        }

        .slider-group input[type="range"] {
            width: 100%;
        }

        /* Theme Toggle & Header Controls */
        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .theme-toggle {
            background: transparent;
            border: 1px solid currentColor;
            color: currentColor;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: currentColor;
            color: var(--dark-bg);
        }

        .export-btn {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        /* Query History */
        .history-panel {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: white;
        }

        .history-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .history-item:hover {
            background: #f8fafc;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-query {
            font-family: monospace;
            font-size: 12px;
            color: #6b7280;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-meta {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 4px;
        }

        /* Custom Attacks */
        .custom-attacks {
            background: #fef7ff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e879f9;
            margin-top: 20px;
        }

        .custom-attacks textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
        }

        .custom-attacks input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        /* Performance Chart */
        .performance-section {
            margin-top: 20px;
        }

        .chart-container {
            height: 300px;
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
        }

        /* Loading Animation */
        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .security-dashboard {
                grid-template-columns: 1fr;
                margin: 20px 10px;
            }
            
            .attack-sequences {
                grid-template-columns: 1fr;
                margin: 20px 10px;
            }
            
            .builder-controls {
                grid-template-columns: 1fr;
            }
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .section {
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .section-header {
            background: white;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--dark-bg);
        }

        .section-content {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-bg);
        }

        .server-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .server-option {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .server-option.active {
            border-color: var(--primary-color);
            background: rgba(37, 99, 235, 0.05);
            color: var(--primary-color);
        }

        .server-option.vulnerable {
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        .server-option.hardened {
            border-color: var(--success-color);
            color: var(--success-color);
        }

        .auth-section {
            display: flex;
            gap: 10px;
            align-items: end;
        }

        .auth-section select,
        .auth-section input {
            flex: 1;
        }

        select, input, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        textarea {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.5;
            height: 200px;
            resize: vertical;
        }

        .quick-queries {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .quick-query-btn {
            padding: 8px 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }

        .quick-query-btn:hover {
            background: #1d4ed8;
        }

        .quick-query-btn.attack {
            background: var(--danger-color);
        }

        .quick-query-btn.attack:hover {
            background: #b91c1c;
        }

        .execute-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .execute-btn:hover {
            background: #1d4ed8;
        }

        .execute-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .response-section {
            grid-column: 1 / -1;
        }

        .response-content {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.5;
            background: var(--dark-bg);
            color: #10b981;
            padding: 20px;
            border-radius: 6px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .error {
            color: #ef4444;
        }

        .warning {
            color: #f59e0b;
        }

        .success {
            color: #10b981;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .metric-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        .attack-scenarios {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .scenario-btn {
            padding: 12px;
            background: var(--warning-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .scenario-btn:hover {
            background: #b45309;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success { background: var(--success-color); }
        .toast.error { background: var(--danger-color); }
        .toast.warning { background: var(--warning-color); }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }
            
            .quick-queries {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è GraphQL Security Testing Dashboard</h1>
            <div class="header-controls">
                <button class="theme-toggle" onclick="toggleDarkMode()">üåô Dark</button>
                <button class="export-btn" onclick="generateReport()">üìä Export Report</button>
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span id="connectionStatus">Checking connection...</span>
                </div>
            </div>
        </div>

        <!-- Security Dashboard -->
        <div class="security-dashboard">
            <div class="risk-meter">
                <div class="risk-gauge">
                    <div class="risk-needle" id="riskNeedle"></div>
                </div>
                <div class="risk-score">Risk: <span id="currentRisk">0</span></div>
            </div>
            <div class="threat-indicators">
                <div class="indicator safe" id="depthIndicator">Depth: <span>Safe</span></div>
                <div class="indicator safe" id="aliasIndicator">Aliases: <span>Normal</span></div>
                <div class="indicator safe" id="introspectionIndicator">Schema: <span>Protected</span></div>
                <div class="indicator safe" id="injectionIndicator">Injection: <span>Clean</span></div>
            </div>
        </div>

        <!-- Attack Sequences -->
        <div class="attack-sequences">
            <button class="sequence-btn" onclick="runAttackSequence('reconnaissance')">üîç Reconnaissance</button>
            <button class="sequence-btn" onclick="runAttackSequence('dos')">üí• DoS Attacks</button>
            <button class="sequence-btn" onclick="runAttackSequence('injection')">üíâ Injection Tests</button>
            <button class="sequence-btn" onclick="runAttackSequence('comprehensive')">üî¨ Full Assessment</button>
        </div>

        <div class="main-content">
            <!-- Server Configuration -->
            <div class="section">
                <div class="section-header">üîß Server Configuration</div>
                <div class="section-content">
                    <div class="form-group">
                        <label>Select Server:</label>
                        <div class="server-selector">
                            <div class="server-option hardened active" data-server="hardened">
                                üõ°Ô∏è Hardened<br>
                                <small>:4001</small>
                            </div>
                            <div class="server-option vulnerable" data-server="vulnerable">
                                ‚ö†Ô∏è Vulnerable<br>
                                <small>:4000</small>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Authentication:</label>
                        <div class="auth-section">
                            <select id="authType">
                                <option value="">No Authentication</option>
                                <option value="user">User Token</option>
                                <option value="admin">Admin Token</option>
                                <option value="custom">Custom Token</option>
                            </select>
                            <input type="text" id="customToken" placeholder="Custom JWT Token" style="display: none;">
                        </div>
                    </div>

                    <div class="metrics">
                        <div class="metric-card">
                            <div class="metric-value" id="totalQueries">0</div>
                            <div class="metric-label">Total Queries</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="avgResponseTime">0ms</div>
                            <div class="metric-label">Avg Response</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="successRate">100%</div>
                            <div class="metric-label">Success Rate</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Query Builder -->
            <div class="section">
                <div class="section-header">üìù Query Builder</div>
                <div class="section-content">
                    <div class="form-group">
                        <label>Quick Queries:</label>
                        <div class="quick-queries">
                            <button class="quick-query-btn" onclick="loadQuery('basic')">üìã Basic Query</button>
                            <button class="quick-query-btn" onclick="loadQuery('users')">üë• Users Query</button>
                            <button class="quick-query-btn" onclick="loadQuery('introspection')">üîç Introspection</button>
                            <button class="quick-query-btn attack" onclick="loadQuery('deep')">üéØ Deep Query</button>
                            <button class="quick-query-btn attack" onclick="loadQuery('alias')">‚ö° Alias Flood</button>
                            <button class="quick-query-btn attack" onclick="loadQuery('complex')">üî• Complex Query</button>
                        </div>
                    </div>

                    <!-- Query Builder -->
                    <div class="query-builder">
                        <h4>üîß Query Builder</h4>
                        <div class="builder-controls">
                            <div class="slider-group">
                                <label>Nesting Depth: <span id="depthValue">1</span></label>
                                <input type="range" id="depthSlider" min="1" max="15" value="1" oninput="updateDepthValue()">
                            </div>
                            <div class="slider-group">
                                <label>Alias Count: <span id="aliasValue">1</span></label>
                                <input type="range" id="aliasSlider" min="1" max="100" value="1" oninput="updateAliasValue()">
                            </div>
                            <div class="slider-group">
                                <label>Complexity Level: <span id="complexityValue">Low</span></label>
                                <input type="range" id="complexitySlider" min="1" max="5" value="1" oninput="updateComplexityValue()">
                            </div>
                        </div>
                        <button onclick="generateAttackQuery()" style="background: var(--warning-color); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">üöÄ Generate Attack Query</button>
                    </div>

                    <div class="form-group">
                        <label>GraphQL Query:</label>
                        <textarea id="queryInput" placeholder="Enter your GraphQL query here...">query {
  posts {
    id
    title
    author {
      name
    }
  }
}</textarea>
                    </div>

                    <button class="execute-btn" onclick="executeQuery()">
                        üöÄ Execute Query
                    </button>
                </div>
            </div>

            <!-- Attack Scenarios -->
            <div class="section">
                <div class="section-header">‚öîÔ∏è Security Attack Scenarios</div>
                <div class="section-content">
                    <div class="attack-scenarios">
                        <button class="scenario-btn" onclick="runAttackScenario('depthBomb')">
                            üí£ Depth Bomb
                        </button>
                        <button class="scenario-btn" onclick="runAttackScenario('aliasFlood')">
                            üåä Alias Flood
                        </button>
                        <button class="scenario-btn" onclick="runAttackScenario('introspectionHack')">
                            üïµÔ∏è Schema Introspection
                        </button>
                        <button class="scenario-btn" onclick="runAttackScenario('injectionTest')">
                            üíâ Injection Test
                        </button>
                        <button class="scenario-btn" onclick="runAttackScenario('rateLimitTest')">
                            üöÄ Rate Limit Test
                        </button>
                        <button class="scenario-btn" onclick="runAttackScenario('authBypass')">
                            üîê Auth Bypass
                        </button>
                    </div>
                </div>
            </div>

            <!-- Response Display -->
            <div class="section response-section">
                <div class="section-header">üìä Response & Analysis</div>
                <div class="section-content">
                    <div id="responseOutput" class="response-content">
Ready to execute GraphQL queries! üöÄ

Select a server, choose your authentication method, and run a query to see the results here.

üõ°Ô∏è Hardened Server Features:
- GraphGuard intelligent security layer
- Query depth limiting (max 7 levels)
- Authentication & authorization required
- Input validation with Zod schemas
- Rate limiting protection

‚ö†Ô∏è Vulnerable Server:
- No security controls
- Unlimited query depth
- No authentication required
- Exposed to all attack vectors
                    </div>
                </div>
            </div>

            <!-- Query History -->
            <div class="section">
                <div class="section-header">üìú Query History</div>
                <div class="section-content">
                    <div id="queryHistory" class="history-panel">
                        <div class="history-item">
                            <div class="history-query">No queries executed yet</div>
                            <div class="history-meta">Start executing queries to see history</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="section performance-section">
                <div class="section-header">üìà Performance Metrics</div>
                <div class="section-content">
                    <div class="chart-container">
                        üìä Performance chart will appear here after executing queries
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom Attacks -->
        <div class="custom-attacks">
            <h4>üéØ Custom Attack Templates</h4>
            <textarea id="customAttackQuery" placeholder="Define custom attack query..."></textarea>
            <input type="text" id="customAttackName" placeholder="Attack name (e.g., 'Custom DoS Attack')">
            <button onclick="saveCustomAttack()" style="background: #e879f9; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">üíæ Save Custom Attack</button>
            <div id="customAttacksList" style="margin-top: 15px;"></div>
        </div>
    </div>

    <script>
        // Configuration
        const servers = {
            hardened: 'http://localhost:4001/graphql',
            vulnerable: 'http://localhost:4000/graphql'
        };

        // Test tokens (generated by hardened server)
        const tokens = {
            user: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiIxIiwiaWF0IjoxNzYzNjkxNTM4LCJleHAiOjE3NjM2OTUxMzh9.rtqCJOLjzJVkzZbG3E6PY-63iM6uOjLHVP5kMGB9yUM',
            admin: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiIzIiwiaWF0IjoxNzYzNjkxNTM4LCJleHAiOjE3NjM2OTUxMzh9.YIFxQavsxj0v2iuXTY0mKp3lZ7PeCQCzjlIoWS8Tkw4'
        };

        let currentServer = 'hardened';
        let metrics = { total: 0, responses: [], totalTime: 0 };

        // Query templates
        const queries = {
            basic: `query {
  posts {
    id
    title
    author {
      name
    }
  }
}`,
            users: `query {
  users {
    id
    name
    email
  }
}`,
            introspection: `query IntrospectionQuery {
  __schema {
    types {
      name
      kind
      description
    }
  }
}`,
            deep: `query DeepQuery {
  posts {
    author {
      posts {
        author {
          posts {
            author {
              posts {
                author {
                  posts {
                    title
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}`,
            alias: `query AliasFlood {
  ${Array.from({length: 30}, (_, i) => `a${i}: posts { id title }`).join('\n  ')}
}`,
            complex: `query ComplexQuery {
  posts {
    id
    title
    body
    author {
      id
      name
      email
      posts {
        id
        title
        comments {
          id
          text
          author {
            id
            name
            posts {
              id
              title
            }
          }
        }
      }
    }
    comments {
      id
      text
      author {
        id
        name
        posts {
          id
          title
        }
      }
    }
  }
}`
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkServerStatus();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Server selection
            document.querySelectorAll('.server-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.server-option').forEach(o => o.classList.remove('active'));
                    this.classList.add('active');
                    currentServer = this.dataset.server;
                    checkServerStatus();
                });
            });

            // Auth type selection
            document.getElementById('authType').addEventListener('change', function() {
                const customToken = document.getElementById('customToken');
                if (this.value === 'custom') {
                    customToken.style.display = 'block';
                } else {
                    customToken.style.display = 'none';
                }
            });
        }

        async function checkServerStatus() {
            const statusElement = document.getElementById('connectionStatus');
            try {
                const response = await fetch(servers[currentServer], {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: '{ __typename }' })
                });
                
                if (response.ok) {
                    statusElement.textContent = `Connected to ${currentServer} server`;
                    statusElement.parentElement.style.background = 'rgba(5, 150, 105, 0.1)';
                    statusElement.parentElement.style.borderColor = 'var(--success-color)';
                    statusElement.parentElement.style.color = 'var(--success-color)';
                } else {
                    throw new Error('Server not responding');
                }
            } catch (error) {
                statusElement.textContent = `${currentServer} server offline`;
                statusElement.parentElement.style.background = 'rgba(220, 38, 38, 0.1)';
                statusElement.parentElement.style.borderColor = 'var(--danger-color)';
                statusElement.parentElement.style.color = 'var(--danger-color)';
            }
        }

        function loadQuery(type) {
            document.getElementById('queryInput').value = queries[type];
        }

        async function executeQuery() {
            const query = document.getElementById('queryInput').value;
            const authType = document.getElementById('authType').value;
            const customToken = document.getElementById('customToken').value;
            
            if (!query.trim()) {
                showToast('Please enter a GraphQL query', 'warning');
                return;
            }

            const startTime = Date.now();
            const executeBtn = document.querySelector('.execute-btn');
            const responseOutput = document.getElementById('responseOutput');

            // Show loading state
            executeBtn.disabled = true;
            executeBtn.textContent = '‚è≥ Executing...';
            responseOutput.textContent = 'Executing query...\n';

            try {
                const headers = { 'Content-Type': 'application/json' };
                
                // Add authentication if selected
                if (authType && authType !== 'custom') {
                    headers['Authorization'] = `Bearer ${tokens[authType]}`;
                } else if (authType === 'custom' && customToken) {
                    headers['Authorization'] = `Bearer ${customToken}`;
                }

                const response = await fetch(servers[currentServer], {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ query })
                });

                const endTime = Date.now();
                const responseTime = endTime - startTime;
                const result = await response.json();

                // Update metrics
                updateMetrics(response.ok, responseTime);

                // Display response
                displayResponse(result, response, responseTime, query);

                if (response.ok && !result.errors) {
                    showToast('Query executed successfully!', 'success');
                } else {
                    showToast('Query completed with issues', 'warning');
                }

            } catch (error) {
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                updateMetrics(false, responseTime);
                displayResponse({ error: error.message }, null, responseTime, query);
                showToast('Query execution failed', 'error');
            }

            // Reset button
            executeBtn.disabled = false;
            executeBtn.textContent = 'üöÄ Execute Query';
        }

        function displayResponse(result, response, responseTime, query) {
            const output = document.getElementById('responseOutput');
            
            let displayText = `üöÄ Query Executed (${responseTime}ms)\n`;
            displayText += `üì° Server: ${currentServer} (${servers[currentServer]})\n`;
            displayText += `üîê Auth: ${document.getElementById('authType').value || 'None'}\n`;
            displayText += `‚è±Ô∏è Response Time: ${responseTime}ms\n`;
            
            if (response) {
                displayText += `üìä Status: ${response.status} ${response.statusText}\n`;
            }
            
            displayText += `\nüìù Query:\n${query}\n\n`;
            
            if (result.errors) {
                displayText += `‚ùå ERRORS:\n`;
                result.errors.forEach((error, i) => {
                    displayText += `${i + 1}. ${error.message}\n`;
                    if (error.extensions) {
                        displayText += `   Extensions: ${JSON.stringify(error.extensions, null, 2)}\n`;
                    }
                });
                displayText += `\n`;
            }
            
            if (result.data) {
                displayText += `‚úÖ DATA:\n${JSON.stringify(result.data, null, 2)}\n`;
            }
            
            if (result.error) {
                displayText += `üí• NETWORK ERROR:\n${result.error}\n`;
            }

            // Security analysis
            displayText += `\nüîç SECURITY ANALYSIS:\n`;
            displayText += analyzeQuerySecurity(query, result);

            output.textContent = displayText;
            
            // Scroll to bottom
            output.scrollTop = output.scrollHeight;
        }

        function analyzeQuerySecurity(query, result) {
            let analysis = '';
            
            // Check query depth
            const depth = calculateQueryDepth(query);
            analysis += `üìè Query Depth: ${depth}${depth > 7 ? ' ‚ö†Ô∏è HIGH' : ' ‚úÖ OK'}\n`;
            
            // Check for introspection
            if (query.includes('__schema') || query.includes('__type')) {
                analysis += `üîç Introspection: DETECTED ‚ö†Ô∏è\n`;
            }
            
            // Check for aliases
            const aliasCount = (query.match(/\w+:/g) || []).length;
            analysis += `üè∑Ô∏è Aliases: ${aliasCount}${aliasCount > 20 ? ' ‚ö†Ô∏è HIGH' : ' ‚úÖ OK'}\n`;
            
            // Check query length
            analysis += `üìê Query Length: ${query.length} chars${query.length > 2000 ? ' ‚ö†Ô∏è LARGE' : ' ‚úÖ OK'}\n`;
            
            // Security verdict
            if (result.errors) {
                const securityBlocked = result.errors.some(e => 
                    e.message.includes('GraphGuard') || 
                    e.message.includes('depth') || 
                    e.message.includes('complexity')
                );
                analysis += `üõ°Ô∏è Security: ${securityBlocked ? 'BLOCKED BY SECURITY CONTROLS' : 'ERROR (Not security related)'}\n`;
            } else {
                analysis += `üõ°Ô∏è Security: QUERY ALLOWED\n`;
            }
            
            return analysis;
        }

        function calculateQueryDepth(query) {
            const openBraces = (query.match(/{/g) || []).length;
            const closeBraces = (query.match(/}/g) || []).length;
            return Math.min(openBraces, closeBraces);
        }

        function updateMetrics(success, responseTime) {
            metrics.total++;
            metrics.responses.push({ success, time: responseTime });
            metrics.totalTime += responseTime;
            
            // Keep only last 100 responses
            if (metrics.responses.length > 100) {
                metrics.responses.shift();
            }
            
            // Update UI
            document.getElementById('totalQueries').textContent = metrics.total;
            document.getElementById('avgResponseTime').textContent = Math.round(metrics.totalTime / metrics.total) + 'ms';
            
            const successCount = metrics.responses.filter(r => r.success).length;
            const successRate = Math.round((successCount / metrics.responses.length) * 100);
            document.getElementById('successRate').textContent = successRate + '%';
        }

        async function runAttackScenario(scenario) {
            showToast(`Running ${scenario} attack scenario...`, 'warning');
            
            switch (scenario) {
                case 'depthBomb':
                    loadQuery('deep');
                    await executeQuery();
                    break;
                case 'aliasFlood':
                    loadQuery('alias');
                    await executeQuery();
                    break;
                case 'introspectionHack':
                    loadQuery('introspection');
                    await executeQuery();
                    break;
                case 'injectionTest':
                    document.getElementById('queryInput').value = `query {
  postsByEmail(email: "'; DROP TABLE users; --") {
    id
    title
  }
}`;
                    await executeQuery();
                    break;
                case 'rateLimitTest':
                    showToast('Running rate limit test (10 rapid requests)...', 'warning');
                    for (let i = 0; i < 10; i++) {
                        setTimeout(() => executeQuery(), i * 100);
                    }
                    break;
                case 'authBypass':
                    document.getElementById('authType').value = '';
                    loadQuery('users');
                    await executeQuery();
                    break;
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // Auto-refresh server status every 30 seconds
        setInterval(checkServerStatus, 30000);

        // ========== ENHANCED FEATURES ==========

        // 1. GraphGuard Risk Metrics Integration
        function updateRiskMeter(riskScore, action) {
            const needle = document.getElementById('riskNeedle');
            const riskDisplay = document.getElementById('currentRisk');
            const angle = Math.min((riskScore / 100) * 180, 180);
            
            needle.style.transform = `rotate(${angle - 90}deg)`;
            riskDisplay.textContent = riskScore.toFixed(1);
            
            // Update threat indicators
            updateThreatIndicators(riskScore, action);
        }

        function updateThreatIndicators(riskScore, action) {
            const indicators = ['depthIndicator', 'aliasIndicator', 'introspectionIndicator', 'injectionIndicator'];
            const classes = ['safe', 'warning', 'danger'];
            
            indicators.forEach(id => {
                const indicator = document.getElementById(id);
                indicator.className = 'indicator ' + (riskScore > 60 ? 'danger' : riskScore > 30 ? 'warning' : 'safe');
            });
        }

        // 3. Attack Sequence Automation
        const attackSequences = {
            reconnaissance: ['introspection', 'users', 'basic'],
            dos: ['deep', 'alias', 'complex'],
            injection: ['basic', 'users'], // Would have injection payloads in real implementation
            comprehensive: ['introspection', 'basic', 'users', 'deep', 'alias', 'complex']
        };

        async function runAttackSequence(sequence) {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.classList.add('running');
            btn.textContent = '‚è≥ Running...';
            btn.disabled = true;

            showToast(`Starting ${sequence} attack sequence...`, 'warning');
            
            for (const attack of attackSequences[sequence]) {
                loadQuery(attack);
                await new Promise(resolve => setTimeout(resolve, 1000)); // Delay
                await executeQuery();
                await new Promise(resolve => setTimeout(resolve, 2000)); // Delay between attacks
            }

            btn.classList.remove('running');
            btn.textContent = originalText;
            btn.disabled = false;
            showToast(`${sequence} sequence completed!`, 'success');
        }

        // 4. Query Builder Interface
        function updateDepthValue() {
            const depth = document.getElementById('depthSlider').value;
            document.getElementById('depthValue').textContent = depth;
        }

        function updateAliasValue() {
            const aliases = document.getElementById('aliasSlider').value;
            document.getElementById('aliasValue').textContent = aliases;
        }

        function updateComplexityValue() {
            const complexity = document.getElementById('complexitySlider').value;
            const levels = ['Low', 'Medium', 'High', 'Very High', 'Extreme'];
            document.getElementById('complexityValue').textContent = levels[complexity - 1];
        }

        function generateAttackQuery() {
            const depth = parseInt(document.getElementById('depthSlider').value);
            const aliases = parseInt(document.getElementById('aliasSlider').value);
            const complexity = parseInt(document.getElementById('complexitySlider').value);

            let query = 'query GeneratedAttack {\n';
            
            // Generate aliases
            for (let i = 0; i < Math.min(aliases, 50); i++) {
                query += `  alias${i}: posts { id title }\n`;
            }
            
            // Generate nested query
            let nestedQuery = '  posts';
            for (let i = 0; i < depth; i++) {
                nestedQuery += ' {\n    ' + (i % 2 === 0 ? 'author' : 'posts');
            }
            for (let i = 0; i < depth; i++) {
                nestedQuery += '\n  }';
            }
            query += nestedQuery + '\n}';

            document.getElementById('queryInput').value = query;
            showToast(`Generated attack query with depth ${depth} and ${aliases} aliases!`, 'warning');
        }

        // 6. Export & Reporting
        function generateReport() {
            const report = {
                timestamp: new Date().toISOString(),
                currentServer: currentServer,
                testSummary: {
                    totalQueries: metrics.total,
                    avgResponseTime: Math.round(metrics.totalTime / metrics.total) || 0,
                    successfulQueries: metrics.responses.filter(r => r.success).length,
                    failedQueries: metrics.responses.filter(r => !r.success).length
                },
                queryHistory: getQueryHistory(),
                securityAnalysis: {
                    serverType: currentServer,
                    protectionLevel: currentServer === 'hardened' ? 'High' : 'None',
                    recommendedActions: currentServer === 'vulnerable' ? 
                        ['Enable query depth limiting', 'Implement complexity analysis', 'Add authentication'] :
                        ['Security controls active', 'Monitoring recommended']
                }
            };
            
            downloadJSON(report, `graphql-security-report-${new Date().toISOString().split('T')[0]}.json`);
            showToast('Security report exported!', 'success');
        }

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 7. Dark Mode Toggle
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            
            const btn = document.querySelector('.theme-toggle');
            btn.textContent = isDark ? '‚òÄÔ∏è Light' : 'üåô Dark';
            
            showToast(`Switched to ${isDark ? 'dark' : 'light'} mode`, 'info');
        }

        // 8. Query History
        function saveQueryHistory(query, server, success, responseTime) {
            const history = JSON.parse(localStorage.getItem('queryHistory') || '[]');
            history.unshift({
                query: query.substring(0, 100) + (query.length > 100 ? '...' : ''),
                fullQuery: query,
                server: server,
                success: success,
                responseTime: responseTime,
                timestamp: Date.now()
            });
            
            // Keep only last 50 queries
            localStorage.setItem('queryHistory', JSON.stringify(history.slice(0, 50)));
            updateQueryHistoryDisplay();
        }

        function updateQueryHistoryDisplay() {
            const history = JSON.parse(localStorage.getItem('queryHistory') || '[]');
            const container = document.getElementById('queryHistory');
            
            if (history.length === 0) {
                container.innerHTML = '<div class="history-item"><div class="history-query">No queries executed yet</div></div>';
                return;
            }
            
            container.innerHTML = history.map(item => `
                <div class="history-item" onclick="loadHistoryQuery('${item.fullQuery.replace(/'/g, "\\'")}')">
                    <div class="history-query">${item.query}</div>
                    <div class="history-meta">${new Date(item.timestamp).toLocaleString()} ‚Ä¢ ${item.server} ‚Ä¢ ${item.success ? '‚úÖ' : '‚ùå'} ${item.responseTime}ms</div>
                </div>
            `).join('');
        }

        function loadHistoryQuery(query) {
            document.getElementById('queryInput').value = query;
            showToast('Query loaded from history', 'info');
        }

        function getQueryHistory() {
            return JSON.parse(localStorage.getItem('queryHistory') || '[]');
        }

        // 9. Custom Attack Templates
        function saveCustomAttack() {
            const query = document.getElementById('customAttackQuery').value;
            const name = document.getElementById('customAttackName').value;
            
            if (!query.trim() || !name.trim()) {
                showToast('Please enter both query and name', 'warning');
                return;
            }
            
            const attacks = JSON.parse(localStorage.getItem('customAttacks') || '[]');
            attacks.push({ name, query, timestamp: Date.now() });
            localStorage.setItem('customAttacks', JSON.stringify(attacks));
            
            updateCustomAttacksList();
            document.getElementById('customAttackQuery').value = '';
            document.getElementById('customAttackName').value = '';
            showToast('Custom attack saved!', 'success');
        }

        function updateCustomAttacksList() {
            const attacks = JSON.parse(localStorage.getItem('customAttacks') || '[]');
            const container = document.getElementById('customAttacksList');
            
            container.innerHTML = attacks.map((attack, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 4px 0; background: white; border-radius: 4px;">
                    <span style="cursor: pointer;" onclick="loadCustomAttack(${index})">${attack.name}</span>
                    <button onclick="deleteCustomAttack(${index})" style="background: #dc2626; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">Delete</button>
                </div>
            `).join('');
        }

        function loadCustomAttack(index) {
            const attacks = JSON.parse(localStorage.getItem('customAttacks') || '[]');
            if (attacks[index]) {
                document.getElementById('queryInput').value = attacks[index].query;
                showToast('Custom attack loaded', 'info');
            }
        }

        function deleteCustomAttack(index) {
            const attacks = JSON.parse(localStorage.getItem('customAttacks') || '[]');
            attacks.splice(index, 1);
            localStorage.setItem('customAttacks', JSON.stringify(attacks));
            updateCustomAttacksList();
            showToast('Custom attack deleted', 'info');
        }

        // Enhanced executeQuery with all new features
        const originalExecuteQuery = executeQuery;
        executeQuery = async function() {
            const query = document.getElementById('queryInput').value;
            const startTime = Date.now();
            
            try {
                await originalExecuteQuery();
                const responseTime = Date.now() - startTime;
                saveQueryHistory(query, currentServer, true, responseTime);
                
                // Simulate GraphGuard risk score (in real implementation, this would come from server response)
                const riskScore = calculateRiskScore(query);
                updateRiskMeter(riskScore, riskScore > 60 ? 'BLOCK' : 'ALLOW');
                
            } catch (error) {
                const responseTime = Date.now() - startTime;
                saveQueryHistory(query, currentServer, false, responseTime);
            }
        };

        function calculateRiskScore(query) {
            let score = 1; // Base score
            
            // Depth analysis
            const depth = calculateQueryDepth(query);
            score += depth * 2;
            
            // Alias analysis
            const aliases = (query.match(/\w+:/g) || []).length;
            score += aliases;
            
            // Introspection
            if (query.includes('__schema') || query.includes('__type')) {
                score += 50;
            }
            
            // Length penalty
            if (query.length > 1000) {
                score += 25;
            }
            
            return Math.min(score, 100);
        }

        // Initialize enhanced features
        document.addEventListener('DOMContentLoaded', function() {
            // Load dark mode preference
            if (localStorage.getItem('darkMode') === 'true') {
                toggleDarkMode();
            }
            
            // Initialize displays
            updateQueryHistoryDisplay();
            updateCustomAttacksList();
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'Enter':
                            e.preventDefault();
                            executeQuery();
                            break;
                        case '1':
                            e.preventDefault();
                            loadQuery('basic');
                            break;
                        case '2':
                            e.preventDefault();
                            loadQuery('introspection');
                            break;
                        case '3':
                            e.preventDefault();
                            loadQuery('deep');
                            break;
                    }
                }
            });
        });
    </script>
</body>
</html>